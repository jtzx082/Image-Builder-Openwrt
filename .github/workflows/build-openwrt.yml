name: Build OpenWrt x86_64

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

permissions:
  contents: write

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  REPO_BRANCH: v24.10.4
  FEEDS_CONF: feeds.conf.default
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Free Disk Space (Optimization)
      uses: jlumbroso/free-disk-space@main
      with:
        # 下面这些设为 true 代表需要删除，从而释放空间
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
        
    - name: Check Available Space
      run: df -hT

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
        file wget python3 python3-pip libelf-dev qemu-utils
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone Source Code
      working-directory: /workdir
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Update & Install Feeds
      working-directory: /workdir/openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate Configuration (.config)
      working-directory: /workdir/openwrt
      run: |
        # 创建自定义配置文件
        cat > .config <<EOF
        # --- Target Configuration (x86_64) ---
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y
        
        # --- RootFS Partition Size (1024MB) ---
        CONFIG_TARGET_KERNEL_PARTSIZE=128
        CONFIG_TARGET_ROOTFS_PARTSIZE=1024
        
        # --- Image Options ---
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        CONFIG_GRUB_IMAGES=y
        CONFIG_GRUB_EFI_IMAGES=y
        
        # --- Excluded Packages ---
        # CONFIG_PACKAGE_libustream-mbedtls is not set
        
        # --- User Requested Packages ---
        CONFIG_PACKAGE_base-files=y
        CONFIG_PACKAGE_ca-bundle=y
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_dropbear=y
        CONFIG_PACKAGE_e2fsprogs=y
        CONFIG_PACKAGE_firewall4=y
        CONFIG_PACKAGE_fstools=y
        CONFIG_PACKAGE_grub2-bios-setup=y
        CONFIG_PACKAGE_kmod-button-hotplug=y
        CONFIG_PACKAGE_kmod-nft-offload=y
        CONFIG_PACKAGE_libc=y
        CONFIG_PACKAGE_libgcc=y
        CONFIG_PACKAGE_logd=y
        CONFIG_PACKAGE_mkf2fs=y
        CONFIG_PACKAGE_mtd=y
        CONFIG_PACKAGE_netifd=y
        CONFIG_PACKAGE_nftables=y
        CONFIG_PACKAGE_odhcp6c=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y
        CONFIG_PACKAGE_opkg=y
        CONFIG_PACKAGE_partx-utils=y
        CONFIG_PACKAGE_ppp=y
        CONFIG_PACKAGE_ppp-mod-pppoe=y
        CONFIG_PACKAGE_procd-ujail=y
        CONFIG_PACKAGE_uci=y
        CONFIG_PACKAGE_uclient-fetch=y
        CONFIG_PACKAGE_urandom-seed=y
        CONFIG_PACKAGE_urngd=y
        
        # --- Network Drivers ---
        CONFIG_PACKAGE_kmod-amazon-ena=y
        CONFIG_PACKAGE_kmod-amd-xgbe=y
        CONFIG_PACKAGE_kmod-bnx2=y
        CONFIG_PACKAGE_kmod-dwmac-intel=y
        CONFIG_PACKAGE_kmod-e1000e=y
        CONFIG_PACKAGE_kmod-e1000=y
        CONFIG_PACKAGE_kmod-forcedeth=y
        CONFIG_PACKAGE_kmod-igb=y
        CONFIG_PACKAGE_kmod-igc=y
        CONFIG_PACKAGE_kmod-ixgbe=y
        CONFIG_PACKAGE_kmod-r8169=y
        CONFIG_PACKAGE_kmod-tg3=y
        
        # --- Filesystem & Graphics ---
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-fs-btrfs=y
        CONFIG_PACKAGE_kmod-drm-i915=y
        
        # --- Utilities & Tools ---
        CONFIG_PACKAGE_bash=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_yq=y
        CONFIG_PACKAGE_ip-full=y
        CONFIG_PACKAGE_tar=y
        CONFIG_PACKAGE_coreutils=y
        CONFIG_PACKAGE_coreutils-stty=y
        CONFIG_PACKAGE_coreutils-base64=y
        CONFIG_PACKAGE_coreutils-nohup=y
        CONFIG_PACKAGE_mount-utils=y
        CONFIG_PACKAGE_script-utils=y
        CONFIG_PACKAGE_unzip=y
        CONFIG_PACKAGE_resolveip=y
        CONFIG_PACKAGE_bind-dig=y
        
        # --- Libraries ---
        CONFIG_PACKAGE_libuci-lua=y
        CONFIG_PACKAGE_libatomic1=y
        CONFIG_PACKAGE_libev=y
        CONFIG_PACKAGE_libsodium=y
        CONFIG_PACKAGE_libpcre2=y
        CONFIG_PACKAGE_libudns=y
        CONFIG_PACKAGE_jsonfilter=y
        CONFIG_PACKAGE_luci-lua-runtime=y
        CONFIG_PACKAGE_libustream-openssl=y
        CONFIG_PACKAGE_ca-certificates=y
        
        # --- Kernel Modules ---
        CONFIG_PACKAGE_kmod-inet-diag=y
        CONFIG_PACKAGE_kmod-netlink-diag=y
        CONFIG_PACKAGE_kmod-nft-socket=y
        CONFIG_PACKAGE_kmod-nft-tproxy=y
        CONFIG_PACKAGE_kmod-tun=y
        
        # --- IPTables & NFT Modules ---
        CONFIG_PACKAGE_iptables-nft=y
        CONFIG_PACKAGE_ipset=y
        CONFIG_PACKAGE_iptables-mod-tproxy=y
        CONFIG_PACKAGE_iptables-mod-socket=y
        
        # --- LuCI & SFTP ---
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_openssh-sftp-server=y
        CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
        CONFIG_PACKAGE_luci-i18n-package-manager-zh-cn=y
        EOF

        make defconfig

    - name: Download Packages
      working-directory: /workdir/openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      working-directory: /workdir/openwrt
      run: |
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s

    - name: Organize Artifacts
      id: organize
      run: |
        mkdir -p ./artifact/
        mv /workdir/openwrt/bin/targets/x86/64/* ./artifact/ 2>/dev/null || true
        rm -rf ./artifact/packages
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Generate Release Tag
      id: tag
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "release_date=$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.release_tag && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt x86_64 ${{ steps.tag.outputs.release_date }}
        body: |
          Target: x86_64 Generic
          RootFS Size: 1024MB
          Build Date: ${{ steps.tag.outputs.release_date }}
          Default IP: 192.168.1.1
          Password: none
        files: ./artifact/*
