name: Build OpenWrt 24.10 (Auto Release)

permissions:
  contents: write

on:
  workflow_dispatch:

env:
  OPENWRT_VERSION: 24.10.5
  ARCH_PATH: x86/64
  TARGET_PROFILE: generic
  KERNEL_PARTSIZE: 128
  ROOTFS_PARTSIZE: 1024

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: 1. Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
        zlib1g-dev gawk git gettext libssl-dev xsltproc \
        wget unzip python3 python3-distutils file vim zstd

    - name: 2. Download & Extract ImageBuilder
      run: |
        # ä¸‹è½½
        wget https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ env.ARCH_PATH }}/openwrt-imagebuilder-${{ env.OPENWRT_VERSION }}-x86-64.Linux-x86_64.tar.zst
        # è§£åŽ‹
        tar -I zstd -xf openwrt-imagebuilder-*.tar.zst
        # âš ï¸ ä¿®å¤ï¼šåˆ é™¤åŽ‹ç¼©åŒ…ï¼Œé˜²æ­¢ mv å‘½ä»¤é€šé…ç¬¦é”™è¯¯åŒ¹é…
        rm openwrt-imagebuilder-*.tar.zst
        # é‡å‘½å
        mv openwrt-imagebuilder-* openwrt-builder

    - name: 3. Configure Partitions
      working-directory: openwrt-builder
      run: |
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=${{ env.KERNEL_PARTSIZE }}" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.ROOTFS_PARTSIZE }}" >> .config

    # --- æ–°å¢žæ­¥éª¤ï¼šæ³¨å…¥è‡ªå®šä¹‰è„šæœ¬ (IP/ç«¯å£/å¯†ç ) ---
    - name: 3.5. Create Custom Network Script
      working-directory: openwrt-builder
      run: |
        mkdir -p files/etc/uci-defaults
        
        cat > files/etc/uci-defaults/99-custom-network << 'EOF'
        #!/bin/sh
        
        # 1. ä¿®æ”¹ LAN å£ IP ä¸º 10.0.0.1
        uci set network.lan.ipaddr='10.0.0.1'
        
        # 2. å°† eth2 å’Œ eth3 æ·»åŠ åˆ°ç½‘æ¡¥ (br-lan)
        uci add_list network.@device[0].ports='eth2'
        uci add_list network.@device[0].ports='eth3'
        
        # 3. æäº¤ç½‘ç»œä¿®æ”¹
        uci commit network
        
        # 4. è®¾ç½® Root å¯†ç ä¸º 'password'
        echo -e "password\npassword" | passwd root
        
        exit 0
        EOF
        
        # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
        chmod +x files/etc/uci-defaults/99-custom-network

    - name: 4. Build Firmware
      working-directory: openwrt-builder
      run: |
        PACKAGES="openssh-sftp-server \
        luci-i18n-base-zh-cn \
        luci-i18n-firewall-zh-cn \
        luci-i18n-package-manager-zh-cn \
        bash curl yq ip-full \
        kmod-inet-diag kmod-nft-socket kmod-nft-tproxy kmod-tun \
        tar coreutils coreutils-stty mount-utils \
        libuci-lua script-utils kmod-fs-btrfs \
        coreutils-base64 coreutils-nohup unzip resolveip \
        kmod-netlink-diag libatomic1 libev libsodium libpcre2 \
        libudns jsonfilter luci-lua-runtime \
        libustream-openssl ca-bundle ca-certificates \
        iptables-nft ipset iptables-mod-tproxy iptables-mod-socket \
        bind-dig luci-compat luci-lib-ipkg \
        sing-box ucode-mod-digest \
        luci \
        -libustream-mbedtls"
        
        # âš ï¸ ä¿®æ”¹ï¼šå¢žåŠ äº† FILES="files" å‚æ•°ï¼Œä½¿è‡ªå®šä¹‰è„šæœ¬ç”Ÿæ•ˆ
        make image PROFILE="${{ env.TARGET_PROFILE }}" PACKAGES="$PACKAGES" FILES="files"

    - name: 5. Organize Files
      id: organize
      run: |
        mkdir -p firmware
        cp openwrt-builder/bin/targets/${{ env.ARCH_PATH }}/*combined-efi.img.gz firmware/ 2>/dev/null || true
        cp openwrt-builder/bin/targets/${{ env.ARCH_PATH }}/*combined.img.gz firmware/ 2>/dev/null || true
        
        if [ "$(ls -A firmware)" ]; then
          echo "STATUS=success" >> $GITHUB_OUTPUT
        else
          echo "Error: No firmware generated"
          exit 1
        fi

    - name: 6. Generate Release Tag
      id: tag
      if: steps.organize.outputs.STATUS == 'success'
      run: |
        # âš ï¸ ä¿®æ”¹ï¼šæ·»åŠ  TZ='Asia/Shanghai' ä»¥èŽ·å–åŒ—äº¬æ—¶é—´
        # ç”Ÿæˆ Tag ç‰ˆæœ¬å· (ä¾‹å¦‚: v20251217-2315)
        echo "release_tag=v$(TZ='Asia/Shanghai' date +"%Y%m%d-%H%M")" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        touch release.txt
        echo "â˜ï¸ OpenWrt Version: ${{ env.OPENWRT_VERSION }}" >> release.txt
        echo "ðŸ“… Build Date: $(TZ='Asia/Shanghai' date "+%Y-%m-%d %H:%M:%S (åŒ—äº¬æ—¶é—´)")" >> release.txt
        echo "ðŸ§ Architecture: x86_64" >> release.txt
        echo "ðŸ“‚ Partitions: Kernel=${{ env.KERNEL_PARTSIZE }}M, RootFS=${{ env.ROOTFS_PARTSIZE }}M" >> release.txt
        echo "ðŸ”§ Customization: IP=10.0.0.1, Ports=eth0-3, RootPwd=password" >> release.txt

    - name: 7. Upload to Releases
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.STATUS == 'success'
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: firmware/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
