name: Build OpenWrt 24.10 (Auto Release)

# âš ï¸ å…³é”®ï¼šèµ‹äºˆ GITHUB_TOKEN å†™æƒé™ï¼Œå¦åˆ™æ— æ³•ä¸Šä¼  Release
permissions:
  contents: write

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

env:
  OPENWRT_VERSION: 24.10.4
  ARCH_PATH: x86/64
  TARGET_PROFILE: generic
  KERNEL_PARTSIZE: 128
  ROOTFS_PARTSIZE: 1024

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: 1. Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
        zlib1g-dev gawk git gettext libssl-dev xsltproc \
        wget unzip python3 python3-distutils file vim zstd

    - name: 2. Download & Extract ImageBuilder
      run: |
        wget https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ env.ARCH_PATH }}/openwrt-imagebuilder-${{ env.OPENWRT_VERSION }}-x86-64.Linux-x86_64.tar.zst
        tar -I zstd -xf openwrt-imagebuilder-*.tar.zst
        mv openwrt-imagebuilder-* openwrt-builder

    - name: 3. Configure Partitions
      working-directory: openwrt-builder
      run: |
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=${{ env.KERNEL_PARTSIZE }}" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.ROOTFS_PARTSIZE }}" >> .config

    - name: 4. Build Firmware
      working-directory: openwrt-builder
      run: |
        # æ’ä»¶åˆ—è¡¨ (åŒ…å« -libustream-mbedtls ä¿®å¤)
        PACKAGES="openssh-sftp-server \
        luci-i18n-base-zh-cn \
        luci-i18n-firewall-zh-cn \
        luci-i18n-package-manager-zh-cn \
        bash curl yq ip-full \
        kmod-inet-diag kmod-nft-socket kmod-nft-tproxy kmod-tun \
        tar coreutils coreutils-stty mount-utils \
        libuci-lua script-utils kmod-fs-btrfs \
        coreutils-base64 coreutils-nohup unzip resolveip \
        kmod-netlink-diag libatomic1 libev libsodium libpcre2 \
        libudns jsonfilter luci-lua-runtime \
        libustream-openssl ca-bundle ca-certificates \
        iptables-nft ipset iptables-mod-tproxy iptables-mod-socket \
        bind-dig luci-compat luci-lib-ipkg \
        sing-box ucode-mod-digest \
        -libustream-mbedtls"
        
        make image PROFILE="${{ env.TARGET_PROFILE }}" PACKAGES="$PACKAGES"

    - name: 5. Organize Files
      id: organize
      run: |
        mkdir -p firmware
        cp openwrt-builder/bin/targets/${{ env.ARCH_PATH }}/*combined-efi.img.gz firmware/ 2>/dev/null || true
        cp openwrt-builder/bin/targets/${{ env.ARCH_PATH }}/*combined.img.gz firmware/ 2>/dev/null || true
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœä¸ºç©ºåˆ™æ ‡è®°å¤±è´¥
        if [ "$(ls -A firmware)" ]; then
          echo "STATUS=success" >> $GITHUB_OUTPUT
        else
          echo "Error: No firmware generated"
          exit 1
        fi

    - name: 6. Generate Release Tag
      id: tag
      if: steps.organize.outputs.STATUS == 'success'
      run: |
        # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾ï¼Œä¾‹å¦‚: v20241210-1530
        echo "release_tag=v$(date +"%Y%m%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "â˜ï¸ OpenWrt Version: ${{ env.OPENWRT_VERSION }}" >> release.txt
        echo "ðŸ“… Build Date: $(date)" >> release.txt
        echo "ðŸ§ Architecture: x86_64" >> release.txt
        echo "ðŸ“‚ Partitions: Kernel=${{ env.KERNEL_PARTSIZE }}M, RootFS=${{ env.ROOTFS_PARTSIZE }}M" >> release.txt

    - name: 7. Upload to Releases
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.STATUS == 'success'
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: firmware/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
